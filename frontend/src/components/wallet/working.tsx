
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// 1st  txid 3202b84061d9f49595476cd8a5316b86159c5f98fd1c754d0a6fcad15d415b9e     with alic test contact
// 2nd txid 791658c255efd6572061716bbfb7f32cde7e95570f588c922d92417cb4bb7857
// 3rd txid 0e6ce96026b211561f66ab02ede37115f1b818ab0d5b15407eeef9085e8690da
// 4th txid d2661f6b330fcdd46cd9e49e0cf480b4bce48fd2ecd50333d3a984ba506f31ad
// 5th txid 432db921aa710ac08dc523cbb09470a27f27eb714faebf7bed46ef9dc18e0f97    message =  719494b123a54728387ad6374447923e3f3bfee654f6236e9dd11eed36d00fbccd13722db4ed957859b2c1ade73d276490d0d5523747f8d1e120290341537bfe800ed037a7f78ba0ba6828ef310a1c4e84
// 6th txid fb6b439e3646af827f80f4af585d6e4f6c3e82f598c3cf679b8654e2b892ecdf  message text 123456789 decrypted = 28b9c03915d89ebee52b57363b868b7b87cbb7b07308650d302258794cae471a49a32dbf179c0ec28a7b55822b46212d2427d23df692867d99
/////
// 1st message to me ; txid a4b4d4aa5019033f2f507fc929f54de899a9a45ab8abf33c117d9d067645e130  message 12346789
// 2nd message to me txid 589f524ae8bec8bf0d8202437bf9e77a84f1603c5e62cf8d48668d6283641cc4  message 123456789
////////////////////////////////////////////////////////////////////////////////////////////////////////////
// api key testnet_65360009fe0348a739b9227d9e770979
// api key 2nd starter testnet_465d52c23f58e0905d9ec733d2ebd131
// No. me =  xpub 03486fc70e31b45fb24094e714ef2f2fed9d86cf9f2158413be380280fdd3f2416 /  
// xpri= 6811543cdaae96cc602c2ed5efe517bf86cecdb0abbe678eb957b86bf8d3ff13
// muCRZXdunSqaKv5REC37Ahf6ZUAK2yqKes








// 1st 42 type message sen=t Alice = 123456789   TXID 2288cb37125972a756e9b3304928b788007b7b83e1fd9ded460d7b740c8b74f0
// 2nd ECDH type message sen=t Alice = 123456789  TXID 549b1a8d921d53d11573b2bdb7fcf2ff4e063f10645025301b6ed5de7e796566


//   1st 42 type
{  
            "value": 0,
            "n": 0,
            "scriptPubKey": {
                "asm": "0 OP_RETURN 193300657b2276223a2234327632222c2269223a22322d6d73672d323032352d30372d30342d30326234363332642d31222c2264223a22322d6461696c792d323032352d30372d3034222c2274223a313735313635383136362c2263223a223135653262306433227d424210330211e4a04b08506cd13347b5d53cb4d033669d1908659c64531f4efc128fb149d402b4632d08485ff1df2db55b9dafd23347d1c47a457072a1e87be26896549a8737bb8823facc88554ad51c35bc8004666dfb70975c02cdc350402200c2e775a7bc92bb6efb3b9de9337be763f3bd",
                "hex": "006a4cdc193300657b2276223a2234327632222c2269223a22322d6d73672d323032352d30372d30342d30326234363332642d31222c2264223a22322d6461696c792d323032352d30372d3034222c2274223a313735313635383136362c2263223a223135653262306433227d424210330211e4a04b08506cd13347b5d53cb4d033669d1908659c64531f4efc128fb149d402b4632d08485ff1df2db55b9dafd23347d1c47a457072a1e87be26896549a8737bb8823facc88554ad51c35bc8004666dfb70975c02cdc350402200c2e775a7bc92bb6efb3b9de9337be763f3bd",
                "type": "nulldata",
                "opReturn": {
                    "type": "OP_RETURN"
                },
                "isTruncated": false
            },
            "scripthash": "9ebc8ec5e99aaf2713474fc261691e83176fa6c897ba0a08df813ed43e485abd"
        },

// 2nd ECDH type
        {
            "value": 0,
            "n": 0,
            "scriptPubKey": {
                "asm": "0 OP_RETURN 1933ec6f9a842d514f6ba0d59231b067d622e5ca618d95c595c18e141b6ee43adc433e7939c613cc763e4cd23232cf433bf600381e18806e2112e2",
                "hex": "006a3b1933ec6f9a842d514f6ba0d59231b067d622e5ca618d95c595c18e141b6ee43adc433e7939c613cc763e4cd23232cf433bf600381e18806e2112e2",
                "type": "nulldata",
                "opReturn": {
                    "type": "OP_RETURN"
                },
                "isTruncated": false
            },
            "scripthash": "43e0a2da5ca020288298b45f55dcc4e83b9f95feaaf893638c87c10746183b4f"
        },


// Cahrlie demo Message spam to charile
// 1st 03ef5f8272f6298dc094269294331ded8fd8385fcde465acb0c79779a2c7293f
// 2nd b96acede623f1f5b0aab564b801ba32d5f2586022988e196d5690582ec23979a
// 3rd bb730e0c010efe85eb0c7ac8a24f32321189765d4c8214973db76b313192436a
// 4th 1965eccb2200e48e25377f27dba6fe7245e07560b8570e69b5eabeb671260978
// 5th 553d87862e20e247a53dfd1b3ed5f678b2a85f835aeae98824f20f5f53cf765c
// 6th 9f0d6fd7793fe129be8dc500035ea00655f1e8b366144ffcd422c09b4f2b508c
// 7th aa8ae15ece10b1d90b913ceaee696c5ef7df228e56b83368885378c2d0217d62
// 8th 01f2f62b41cdac35576de7367247b13dc6216521027424e9eda60a112f3da596
// 9th 0e0d03f9a46b22990c50996ccc6503c7df867c09b96f6007d51572dcc1392e8e
// 10th d46adb317faeaea7cab6a8d39ba43fc9d88c7f1223ee4cb15b493de71a29a507

// Dana demo
// 1st 90ffb777c2a054b35001387e979c14b0b87ab000c7e16f3187d361eb6318d62b
// 2nd a50a324f22c7376acb9d0babf5c56548957eeff32a2865334b5e640b5a62ad15
// 3rd 630616e635faf8d19f9a1a3616e6303ae98559f4b457098aafc5530ea3f51153
// 4th 606907f78fe0d8b5c206634d81875d9603a4015b85075e591d38b0ac013c5746
// 5th 3ea56bad76e17d7d69205d3e0acdd47938787a9fdcb195c7580d4f47908fde6c
// 6th b654b4255eb29a40c645d218ed4673dddd8003d2d898c9336ecf2ca54005a037
// 7th 004a6f677eda725ec898133eb3ee0947d22fa5f841ba34bc654e915786894965
// 8th 2f5dc79846e3b66eef372c0a72fd2acc6d4857a2f6eed12a5650668e5c4064c1
// 9th ad71b037862e5b02dbffa40d909f3ea7a18e7a6865a73c8009cf4b0fded6b302
// 10th 9ddf4fc834ca6b9150f4ea255bb929e5382941826e1d0fb35c7b112fe717818f

// Dana demo
// 42 1st f3d8f01b095928986684ccfe913555855880ac2b33eaa2ea13dbf47e81be7083
// 42 2nd 95c7f60826d34e9b0f4c47b01b62b7ce9685beec28e4b8e7eca69f0ed2fc3a88
// 42 3rd 02c42c31e2cd61e84e75d852b90726b80b753748cbd074920ef91560e4f813b9
// 42 4th 857ecbb6b6b52320f5b52dc9233905c0a9e54da082f19f8b3f5cb69260865ed6
// 42 5th 5edc436ff91ad37c4c4763c2a28af3e56bf6b35d0b57757da2604f9d1fb929ce
// 42 6th c38f9905e5253a17dadcf9bd51aa73b5772066f76436e71c952a2602f4510997
// 42 7th c08eab26e9090554de9af0ce7fd9cfdeae1abf10910096f96f287face5fb75e2
// 42 8th 76acee8b41b83e550c9cc35d8430b5d6064d911dfc3da9a563b0bb7bf4cf7f84
// 42 9th 7610c8b6da4b1acf80e0dedfd1065ef2ffae891ea4ce088af798c979b5df200f
// 42 10th 578f6c65d2d5428fea69f39e07afffceffeb4419357c75e3fa7c372861820be5

// Dana demo
// 1st 6713e4c7390abaab3939d9a6911f25b38e85c39596a91d077031e3e4f7a259a5
// 2nd 7b62652d9db25e37ce49f53227f7a2f18d7da8bdd82e16fbbaa4669f8cb19471
// 3rd d7e812faccab4f11ee3050c82792e3d76e2ab1f7673a89628ebf20045628a244
// 4th 41ad6e4175ab3f8cc1058b0651e7dbe26b379497fe9695caa1258c0a3796fe45
// 5th 96d0ce0d9c0cabd470106c2abcc96d50c4a9f938791ad824f3987cf29a49b9f4


// Dana demo
// 42 1st f3d8f01b095928986684ccfe913555855880ac2b33eaa2ea13dbf47e81be7083
// 42 2nd e9750c47ea7e90470932fc63d4e8b08e126341a70b8faeb82bef95c81ddfbabc
// 42 3rd 909f6e00a6b4006b4213a0a3368355c94f1a3d06aa116061340a0663e7b1be66
// 42 4th d6d6e71eee6f4e841292654c27d57a6150568b6bf7c8b09dd4a6f0d38c7b3ce4
// 42 5th 5a7295b60e78cd99ad9afc6f28589772a2ea8c0e7c5c4d91543219db634f8e3f








2288cb37125972a756e9b3304928b788007b7b83e1fd9ded460d7b740c8b74f0






// Enhanced Type42AdvancedEncryption with proper BRC-42 invoice numbers and hierarchical key derivation
class Type42AdvancedEncryption {
  masterKey: PrivateKey;
  network: Network;
  invoiceCounter: Map<string, number>;
  messageCache: Map<string, string>;

  constructor(masterPrivateKey: PrivateKey, network: Network = 'mainnet') {
    this.masterKey = masterPrivateKey;
    this.network = network;
    this.invoiceCounter = new Map();
    this.messageCache = new Map();
  }

  // Generate BRC-42 compliant invoice number
  generateInvoiceNumber(contactPubKey: PublicKey, purpose: string = 'msg'): string {
    const today = new Date();
    const dateStr = `${today.getUTCFullYear()}-${(today.getUTCMonth() + 1).toString().padStart(2, '0')}-${today.getUTCDate().toString().padStart(2, '0')}`;
    
    // Use first 8 chars of contact's pubkey as identifier
    const contactId = contactPubKey.toString().substring(0, 8);
    const counterKey = `${dateStr}-${contactId}-${purpose}`;
    
    // Get and increment counter
    const counter = (this.invoiceCounter.get(counterKey) || 0) + 1;
    this.invoiceCounter.set(counterKey, counter);
    
    // BRC-42 format: 2-purpose-date-identifier-counter
    return `2-${purpose}-${dateStr}-${contactId}-${counter}`;
  }

  // Hierarchical key derivation: Master → Conversation → Daily → Message
  async deriveMessageKey(recipientPubKey: PublicKey, invoiceNumber: string): Promise<{
    conversationKey: PrivateKey;
    dailyKey: PrivateKey;
    messageKey: PrivateKey;
  }> {
    // Layer 1: Conversation key (stable per contact)
    const conversationInvoice = `2-conversation-${recipientPubKey.toString().substring(0, 16)}`;
    const conversationKey = this.masterKey.deriveChild(recipientPubKey, conversationInvoice);
    
    // Layer 2: Daily key (rotates daily)
    const dailyInvoice = this.getDailyInvoiceNumber();
    const dailyKey = conversationKey.deriveChild(recipientPubKey, dailyInvoice);
    
    // Layer 3: Message-specific key
    const messageKey = dailyKey.deriveChild(recipientPubKey, invoiceNumber);
    
    return {
      conversationKey,
      dailyKey,
      messageKey
    };
  }

  // Generate daily invoice number
  getDailyInvoiceNumber(): string {
    const today = new Date();
    const dateStr = `${today.getUTCFullYear()}-${(today.getUTCMonth() + 1).toString().padStart(2, '0')}-${today.getUTCDate().toString().padStart(2, '0')}`;
    return `2-daily-${dateStr}`;
  }

  // Calculate message integrity checksum
  calculateChecksum(message: string): string {
    const messageBytes = Utils.toArray(message, 'utf8');
    const hash = Hash.sha256(messageBytes);
    return Utils.toHex(hash).substring(0, 8); // First 8 chars of SHA256
  }

  // Encrypt message with Type-42 Advanced (multi-layer)
  async encryptMessage(recipientMasterPubKey: PublicKey, message: string): Promise<{ encrypted: string, metadata: any }> {
    try {
      // Generate invoice number
      const invoiceNumber = this.generateInvoiceNumber(recipientMasterPubKey);
      
      // Derive hierarchical keys
      const keys = await this.deriveMessageKey(recipientMasterPubKey, invoiceNumber);
      
      // Calculate checksum for integrity
      const checksum = this.calculateChecksum(message);
      
      // Use SDK's EncryptedMessage with the message-specific key
      const messageBytes = Utils.toArray(message, 'utf8');
      const encrypted = EncryptedMessage.encrypt(
        messageBytes,
        keys.messageKey,
        recipientMasterPubKey
      );
      
      // Create compact metadata
      const metadata = {
        v: '42v2', // Shorter version identifier
        i: invoiceNumber,
        d: this.getDailyInvoiceNumber(),
        t: Math.floor(Date.now() / 1000), // Unix timestamp (seconds)
        c: checksum
      };
      
      return {
        encrypted: Utils.toHex(encrypted),
        metadata
      };
    } catch (error) {
      console.error('Type-42 encryption error:', error);
      throw error;
    }
  }

  // Decrypt message with Type-42 Advanced (with caching)
  async decryptMessage(senderMasterPubKey: PublicKey, encryptedHex: string, metadata: any): Promise<string> {
    try {
      // Check cache first
      const cacheKey = `${metadata.i}-${encryptedHex.substring(0, 16)}`;
      if (this.messageCache.has(cacheKey)) {
        console.log('Returning cached decryption');
        return this.messageCache.get(cacheKey)!;
      }
      
      // Derive the same keys using the invoice number
      const keys = await this.deriveMessageKey(senderMasterPubKey, metadata.i);
      
      // Decrypt using the SDK
      const encryptedBytes = Utils.toArray(encryptedHex, 'hex');
      const decrypted = EncryptedMessage.decrypt(encryptedBytes, keys.messageKey);
      const message = Utils.toUTF8(decrypted);
      
      // Verify checksum if present
      if (metadata.c) {
        const calculatedChecksum = this.calculateChecksum(message);
        if (calculatedChecksum !== metadata.c) {
          console.warn('Message checksum mismatch - possible tampering');
          throw new Error('Message integrity check failed');
        }
      }
      
      // Cache the result
      this.messageCache.set(cacheKey, message);
      
      return message;
    } catch (error) {
      console.error('Type-42 decryption error:', error);
      throw error;
    }
  }

  // Fallback to standard ECDH for backward compatibility
  async decryptStandardMessage(senderPubKey: PublicKey, encryptedHex: string): Promise<string> {
    try {
      const sharedSecret = this.masterKey.deriveSharedSecret(senderPubKey);
      let sharedSecretArray;
      
      if (typeof sharedSecret.toArray === 'function') {
        sharedSecretArray = sharedSecret.toArray();
      } else if (typeof sharedSecret.toHex === 'function') {
        sharedSecretArray = Utils.toArray(sharedSecret.toHex(), 'hex');
      } else {
        const hexString = sharedSecret.toString(16).padStart(64, '0');
        sharedSecretArray = Utils.toArray(hexString, 'hex');
      }
      
      const symmetricKey = new SymmetricKey(Hash.sha256(sharedSecretArray));
      const encryptedBytes = Utils.toArray(encryptedHex, 'hex');
      return symmetricKey.decrypt(encryptedBytes, 'utf8');
    } catch (error) {
      throw error;
    }
  }

  // Clear message cache (call periodically to free memory)
  clearCache() {
    this.messageCache.clear();
  }

  // Get cache size
  getCacheSize(): number {
    return this.messageCache.size;
  }
}